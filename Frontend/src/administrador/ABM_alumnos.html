<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../../styles/style.css">
    <link rel="stylesheet" href="../../styles/footer.css">
    <link rel="stylesheet" href="../../styles/menu.css">
    <link rel="stylesheet" href="../../styles/administrador.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>Unión Mediterránea - Taekwondo IFT</title>
    <link rel="shortcut icon" href="../../assets/union.ico" type="image/x-icon">
</head>

<style>
    /* Estilo para la tabla */
    .table-container {
    overflow-x: auto;
    margin: 20px 0;
}

.table {
width: 100%;
border-collapse: collapse;
}

.table th, .table td {
text-align: left;
padding: 12px;
border-bottom: 1px solid #ddd;
}

.table th {
background-color: #323232;
color: white;
}

.table td{
    text-align: center;
}
.table-striped tbody tr:nth-child(even) {
background-color: #63666B !important; /* Color de fondo alterno */
}

.table tbody tr:hover {
background-color: #e0e0e0; /* Color al pasar el ratón */
}
.icon-download {
    color: rgba(0, 191, 255, 0.664);
    cursor: pointer; /* Cambia el cursor al pasar el ratón */
    font-size: 25px;
    padding: 0 3px;
}
.icon-edit{
    color: rgba(0, 153, 255, 0.664);
    cursor: pointer; /* Cambia el cursor al pasar el ratón */
    font-size: 25px;
    padding: 0 3px;
}

.icon-download-disabled, .icon-disabled {
    color: #63666B;
    cursor: not-allowed; /* Cambia el cursor para indicar que no se puede hacer clic */
    font-size: 25px;
    padding: 0 3px;
}

.icon-ban {
    color: #f36b2b;
    cursor: pointer;
    font-size: 25px;
    padding: 0 3px;
}
.icon-remove {
    color: #f3422b;
    cursor: pointer;
    font-size: 25px;
    padding: 0 3px;
}

.icon-add {
    color: rgba(0, 128, 0, 0.664);
    cursor: pointer;
    font-size: 25px;
    padding: 0 3px;
}

select {
    width: 100%;
  padding: 16px;
  background-color: #d5d7d8;
  border: none;
  border-radius: 5px;
  font-size: 14px;
}
#confirmMessage{
    text-align: center;
    font-size: larger;
}
select:focus {
    border-color: #f36b2b;
}

select option {
    color: #63666B; /* Ajusta el color de las opciones dentro del select */
}
/* Estilos para el modal */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%;
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); /* Fondo semitransparente */
    padding-top: 60px;
}

.modal-content {
    background-color: #323232 !important;
    margin: 5% auto; 
    padding: 50px;
    width: 85%;
    max-width: 900px; /* Tamaño máximo */
    border-radius: 10px;
}

form label{
    margin-top: 12px !important;
}
.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    position: absolute;
    right: 50px;
    top: 10px;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

button {
    background-color: #4CAF50; /* Verde */
    color: D2D2D2;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    border-radius: 5px;
    margin-top: 10px;
}

button:hover {
    background-color: #45a049;
}


.modal h2{
    color: #D2D2D2;
}
/* Estilo para los campos readonly */
input[readonly], select[readonly] {
    opacity: 0.6;
    color: #777; /* Color de texto gris oscuro */
    border: 1px solid #D2D2D2; /* Borde gris claro */
    cursor: not-allowed; /* Cursor indicando que no se puede editar */
}

/* Opcional: cambiar el color del texto cuando está en readonly */
input[readonly]:focus, select[readonly]:focus {
    outline: none; /* Quitar el borde de enfoque */
}

#formEdicion {
        display: flex;
        flex-direction: column;
    }

    #formEdicion button {
        color: #D2D2D2;
        padding: 15px 50px; /* Tamaño del botón */
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        text-align: center;
        display: block;
        background-color: #f36b2b;
        align-self: center; /* Centra solo el botón */
        margin-top: 20px; /* Espacio superior */
        
        
        
    }

    #formEdicion button:hover {
        background-color: #f36b2b;
        transform: scale(1.05); /* Efecto de aumento en el hover */
    }
    
    

</style>
<body   >
    <header class="navbar">
        <div class="navbar-left">
            <a href="../../Index.html">
                <img src="../../assets/log4.png" alt="Logo" class="navbar-logo">
                <h1 class="navbar-title">ADMINISTRACION</h1>
            </a>
        </div>
        <nav class="navbar-menu" id="navbar-menu">
            <ul>
                <img src="../../assets/log1.png" alt="Logo" class="navbar-logo-U">
                <li><a href="ABM_publicaciones.html">Publicaciones</a></li>
                <li><a id="actual" href="ABM_alumnos.html">Miembros</a></li>
                <li><a href="ABM_sedes.html">Escuelas</a></li>
                <li><a href="../login.html" class="login-btn" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </nav>
        <i class="fas fa-bars hamburger" id="hamburger"></i>
    </header>
    <!-- Loader -->
    <!-- <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div> -->
    <div class="alert-container">
        <div id="alert-aviso" class="alert alert-aviso">            
        </div>
        <div id="alert-success" class="alert alert-success">            
        </div>
        <div id="alert-error" class="alert alert-danger">
        </div>
    </div>
    <main class="container">
        <h2 class="my-4">MIEMBROS</h2>
        
        <section class="search-filters mb-4">
            <form action="#" method="GET">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" />
                    </div>
                    <div class="filter-group">
                        <label for="apellido">Apellido</label>
                        <input type="text" id="apellido" name="apellido" class="form-control" />
                    </div>
                    <div class="filter-group">
                        <label for="dni">N° Documento</label>
                        <input type="text" id="dni" name="dni" class="form-control" />
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label for="escuela">Escuela</label>
                        <select id="escuela" name="escuela" >
                            <option value="">Selecciona su escuela</option>
                            <!-- Opciones dinámicas -->
                        </select>   
                    </div>
                    <div class="filter-group">
                        <label for="cinto">Cinto</label>
                        <select id="cinto" name="cinto" >
                            <option value="">Selecciona un cinto</option>
                            <!-- Opciones dinámicas -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="estado">Estado</label>
                        <select id="estado" name="estado" >
                            <option value="">Selecciona un estado</option>
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                    
                </div>

                <div class="filter-row right-align">
                    <button type="submit" class="search-button btn btn-secondary">Buscar</button>
                    <button type="button" class="clear-button btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
            </form>
        </section>
        <section>
            <div class="table-container">
                <table id="miTabla" class="table table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Documento</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Telefono</th>
                            <th>Edad</th>
                            <th>Factor</th>
                            <th>Cinturon</th>
                            <th>Escuela</th>
                            <th>Rol</th>
                            <th>Estado</th> 
                            <th>Acciones</th>
                            <th>---</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas generadas dinámicamente con JavaScript -->
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="records-count"><span id="totalRegistros">0</span></div>
                    <div>
                        Página:
                        <select id="pageSelect">
                            <option value="1">1</option>
                            <!-- Páginas generadas dinámicamente -->
                        </select>
                        de <span id="totalPaginas"></span>
                    </div>
                    <button class="export-btn btn btn-secondary" onclick="exportToExcel()">Exportar</button>
                </div>
            </div>
        </section>
    </main>
    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="confirmacion-modal" style="display: none;">
        <div class="modal-content-confirmacion">
            <div class="modal-header-confirmacion">
                <h5 class="modal-title">Confirmación</h5>
                <button class="btn-close-confirmacion" id="closeConfirmModal">&times;</button>
            </div>
            <div class="confirmacion-modal-body">
                <p id="confirmMessage">¿Estás seguro de realizar esta acción?</p>
            </div>
            <div class="modal-footer-confirmacion">
                <button type="button" class="btn btn-cancelar" id="cancelConfirmButton">Cancelar</button>
                <button type="button" class="btn btn-confirmar" id="confirmActionButton">Confirmar</button>
            </div>
        </div>
    </div>  

    <!-- Modal de Edición -->
<div id="modalEdicion" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalEdicion()">&times;</span>
        <h2>Editar Miembro</h2>

        <!-- Imagen centrada debajo del título -->
        <div id="imagenPreview" style="text-align: center; margin-bottom: 10px;">
            <img id="imagenActual" src="" alt="Previsualización de Imagen" 
                style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; margin-bottom: 10px; border: 2px solid #ddd;">
        </div>

        <form id="formEdicion">
            <div class="mb-3">
                <label for="dni_miembro" class="form-label">N° Documento</label>
                <input type="text" class="form-control" id="dni_miembro2" name="dni_miembro" readonly>
            </div>

            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre2" name="nombre" required>
            </div>

            <div class="mb-3">
                <label for="apellido" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="apellido2" name="apellido" required>
            </div>

            <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="tel" class="form-control" id="telefono2" name="telefono" pattern="[0-9]{10}" title="Debe contener 10 dígitos" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email2" name="email" required>
            </div>

            <div class="mb-3">
                <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                <input type="date" class="form-control" id="fecha_nacimiento2" name="fecha_nacimiento" max="${new Date().toISOString().split('T')[0]}" required>
            </div>

            <div class="mb-3">
                <label for="grupo_sanguineo" class="form-label">Grupo Sanguíneo</label>
                <select class="form-control" id="grupo_sanguineo2" name="grupo_sanguineo" required>
                    <option value="A+" selected>A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="rol" class="form-label">Rol</label>
                <input type="text" class="form-control" id="rol2" name="rol" readonly>
            </div>

            


            <div class="mb-3">
                <label for="direccion" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="direccion2" name="direccion" required>
            </div>

            <div class="mb-3">
                <label for="cinto" class="form-label">Cinto</label>
                <select class="form-control" id="cinto2" name="cinto"></select>
            </div>

            <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <input type="text" class="form-control" id="activo2" name="activo" readonly>
            </div>

            <div class="mb-3">
                <label for="escuela" class="form-label">Escuela</label>
                <select class="form-control" id="escuela2" name="escuela"></select>
            </div>
            <div class="mb-3">
                <label for="dni_tutor" class="form-label">N° Documento Tutor</label>
                <input type="text" class="form-control" id="dni_tutor2" name="dni_tutor" readonly>
            </div>

            <div class="mb-3">
                <label for="relacion_tutor" class="form-label">Relación con el Tutor:</label>
                <input type="text" class="form-control" id="relacion_tutor2" name="relacion_tutor" required>
            </div>
            <div class="mb-3">
                <label for="nombre_tutor" class="form-label">Nombre del Tutor</label>
                <input type="text" class="form-control" id="nombre_tutor2" name="nombre_tutor" required>
            </div>
            <div class="mb-3">
                <label for="apellido_tutor" class="form-label">Apellido Tutor</label>
                <input type="text" class="form-control" id="apellido_tutor2" name="apellido_tutor" required>
            </div>
            <div class="mb-3">
                <label for="telefono_tutor" class="form-label">Teléfono Tutor</label>
                <input type="tel" class="form-control" id="telefono_tutor2" name="telefono_tutor" pattern="[0-9]{10}" title="Debe contener 10 dígitos" required>
            </div>
            

            <button type="button" class="btn btn-primary" onclick="actualizarMiembro()">Actualizar</button>
        </form>
    </div>
</div>






    
    <footer>
        <div class="footer">
            <div class="footer-content">
                <img src="../../assets/union-logo.png" alt="Logo Unión Mediterránea de Taekwondo" class="footer-logo">
                <div class="footer-icons-container">
                    <div class="icon-arrow">
                        <a href="#"><i class="fa-solid fa-arrow-up"></i></a>
                    </div>
                    <div class="footer-icons">
                        <a target="_blank" href="https://www.facebook.com/p/Union-Mediterranea-de-Taekwondo-100063475813834/"><i class="fa-brands fa-facebook"></i></a>
                        <a target="_blank" href="https://www.instagram.com/union_mediterranea/"><i class="fa-brands fa-instagram"></i></a>
                        <a target="_blank" href="#"><i class="fa-brands fa-youtube"></i></a>
                        <a target="_blank" href="https://wa.me/3517014308"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                    <a href="mailto:supportunion@gmail.com" class="footer-email">supportunion@gmail.com</a>
                </div>
                <div class="footer-right">
                    <img src="../../assets/fetra-logo.png" alt="Logo Federación Taekwondo" class="footer-logo">
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>UNION MEDITERRANEA DE TAEKWONDO 2024</p>
        </div>
    </footer>
        
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="../../controllers/public/menu.js"></script>
    <script src="../../controllers/controllers-publicaciones/manejo-modales.js"></script>
    <script>
        let currentAction = null;
        let currentDni = null;


        let dniTutorOriginal = null; // Variable global para almacenar el DNI original del tutor

function abrirModalEdicion(dni) {
    document.body.classList.add('no-scroll'); // Bloquear el scroll
    console.log("DNI del miembro:", dni);
    const modal = document.getElementById('modalEdicion');
    modal.style.display = 'block';

    const miembro = miembros.find(m => m.dni_miembro === dni);
    console.log("Miembro encontrado:", miembro);

    if (miembro) {
        // Rellenar campos del miembro
        document.getElementById('dni_miembro2').value = miembro.dni_miembro;
        document.getElementById('nombre2').value = miembro.nombre;
        document.getElementById('apellido2').value = miembro.apellido;
        document.getElementById('telefono2').value = miembro.telefono;
        document.getElementById('email2').value = miembro.email;

        const fechaNacimiento = new Date(miembro.fecha_nacimiento);
        const fechaFormateada = fechaNacimiento.toISOString().split('T')[0];
        document.getElementById('fecha_nacimiento2').value = fechaFormateada;

        document.getElementById('grupo_sanguineo2').value = miembro.grupo_sanguineo;
        document.getElementById('direccion2').value = miembro.direccion;
        document.getElementById('activo2').value = miembro.activo ? 'Activo' : 'Inactivo';
        document.getElementById('rol2').value = miembro.rol;
        const imagenSrc = miembro.imagen ? `../../../Backend/${miembro.imagen}` : '../../../Backend/uploads/default.jpg';
        document.getElementById('imagenActual').src = imagenSrc || 'placeholder-image-url.jpg';
        cargarCintos(miembro.cinto);
        cargarEscuelas(miembro.escuela);

        // Cargar la relación del tutor desde el miembro
        const relacionTutorField = document.getElementById('relacion_tutor2');
        if (relacionTutorField) {
            relacionTutorField.value = miembro.relacion_tutor || 'No especificada';
        } else {
            console.error("El campo 'relacion_tutor2' no está disponible en el DOM.");
        }

        // Solicitar los datos del tutor si hay un DNI de tutor
        if (miembro.dni_tutor) {
            dniTutorOriginal = miembro.dni_tutor; // Guardar el DNI original del tutor
            const token = localStorage.getItem('authToken');
            fetch(`http://localhost:3000/tutores/${miembro.dni_tutor}`, { // Usar el DNI original aquí
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Error al obtener los datos del tutor.");
                    return response.json();
                })
                .then(tutor => {
                    document.getElementById('dni_tutor2').value = miembro.dni_tutor || '';
                    document.getElementById('nombre_tutor2').value = tutor.nombre || '';
                    document.getElementById('apellido_tutor2').value = tutor.apellido || '';
                    document.getElementById('telefono_tutor2').value = tutor.telefono || '';
                })
                .catch(error => {
                    console.error("Error al cargar los datos del tutor:", error);
                    document.getElementById('nombre_tutor2').value = 'No disponible';
                    document.getElementById('apellido_tutor2').value = 'No disponible';
                    document.getElementById('telefono_tutor2').value = 'No disponible';
                });
        } else {
            // Si no hay DNI del tutor, limpiar los campos relacionados
            dniTutorOriginal = null; // Limpiar variable global si no hay tutor
            document.getElementById('nombre_tutor2').value = 'No asignado';
            document.getElementById('apellido_tutor2').value = 'No asignado';
            document.getElementById('telefono_tutor2').value = 'No asignado';
        }
    }
}

function actualizarMiembro() {
    const form = document.getElementById('formEdicion');
    const datos = new FormData(form);
    const token = localStorage.getItem('authToken');
    const tutorActualizado = {
        nuevo_dni_tutor: datos.get('dni_tutor'),
        nombre: datos.get('nombre_tutor'),
        apellido: datos.get('apellido_tutor'),
        telefono: datos.get('telefono_tutor'),
    };

    const miembroActualizado = {
        dni_miembro: datos.get('dni_miembro'),
        nombre: datos.get('nombre'),
        apellido: datos.get('apellido'),
        telefono: datos.get('telefono'),
        email: datos.get('email'),
        fecha_nacimiento: datos.get('fecha_nacimiento'),
        grupo_sanguineo: datos.get('grupo_sanguineo'),
        direccion: datos.get('direccion'),
        activo: datos.get('activo') === 'Activo',
        id_rol: '1',
        id_cinto: datos.get('cinto'),
        id_escuela: datos.get('escuela'),
        dni_tutor: datos.get('dni_tutor'),
        relacion_tutor: datos.get('relacion_tutor'),
    };
    
    // Actualizar datos del tutor
    fetch(`http://localhost:3000/tutores/${dniTutorOriginal}/completo`, { // Usar el DNI original aquí
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(tutorActualizado),
    })
    .then(response => {
        if (!response.ok) throw new Error('Error al actualizar el tutor.');
        return fetch(`http://localhost:3000/miembros/${miembroActualizado.dni_miembro}/completo`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(miembroActualizado),
        });
    })
    .then(response => {
        if (!response.ok) throw new Error('Error al actualizar el miembro.');
        showAlert('success', 'Datos actualizados con éxito.');
        cerrarModalEdicion();
        cargarMiembros();
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', `Error al actualizar: ${error.message}`);
    });
}

function cargarCintos(cintoSeleccionado) {
    const cintoSelect = document.getElementById('cinto2');
    const token = localStorage.getItem('authToken'); // Obtén el token almacenado

    fetch('http://localhost:3000/cintos', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}` // Header con el token
            
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            cintoSelect.innerHTML = ''; // Limpiar las opciones anteriores
            let preseleccionado = false;

            data.forEach(cinto => {
                const option = document.createElement('option');
                option.value = cinto.id_cinto; // Usar id_cinto como valor
                option.textContent = cinto.descripcion;

                // Verificar coincidencia con descripcion
                if (cinto.descripcion === cintoSeleccionado) {
                    option.selected = true;
                    preseleccionado = true;
                }

                cintoSelect.appendChild(option);
            });

            // Si no se encontró un cinto preseleccionado, seleccionar la primera opción por defecto
            if (!preseleccionado && data.length > 0) {
                cintoSelect.selectedIndex = 0;
            }

            console.log("Cintos cargados:", data);
            console.log("Cinto seleccionado:", cintoSeleccionado);
        })
        .catch(error => {
            console.error('Error al cargar los cintos:', error);
        });
}

function cargarEscuelas(escuelaSeleccionada) {
    const escuelaSelect = document.getElementById('escuela2');
    const token = localStorage.getItem('authToken'); // Obtén el token almacenado

    fetch('http://localhost:3000/escuelas', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}` // Header con el token
            
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            escuelaSelect.innerHTML = ''; // Limpiar las opciones anteriores
            let preseleccionado = false;

            data.forEach(escuela => {
                const option = document.createElement('option');
                option.value = escuela.id_escuela; // Usar id_escuela como valor
                option.textContent = escuela.nombre;

                // Verificar coincidencia con nombre
                if (escuela.nombre === escuelaSeleccionada) {
                    option.selected = true;
                    preseleccionado = true;
                }

                escuelaSelect.appendChild(option);
            });

            // Si no se encontró una escuela preseleccionada, seleccionar la primera opción por defecto
            if (!preseleccionado && data.length > 0) {
                escuelaSelect.selectedIndex = 0;
            }

            console.log("Escuelas cargadas:", data);
            console.log("Escuela seleccionada:", escuelaSeleccionada);
        })
        .catch(error => {
            console.error('Error al cargar las escuelas:', error);
        });
}




// Cargar cintos al select
document.addEventListener('DOMContentLoaded', () => {
    const cintoSelect = document.getElementById('cinto');
    const token = localStorage.getItem('authToken'); // Obtén el token almacenado

    fetch('http://localhost:3000/cintos', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}` // Header con el token
            
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            data.forEach(cinto => {
                const option = document.createElement('option');
                option.value = cinto.id_cinto;
                option.textContent = cinto.descripcion;
                cintoSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar los cintos:', error);
        });
});


document.addEventListener('DOMContentLoaded', () => {
    const escuelaSelect = document.getElementById('escuela');
    const token = localStorage.getItem('authToken'); // Obtén el token almacenado

    fetch('http://localhost:3000/escuelas', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}` // Header con el token
            
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            data.forEach(escuela => {
                const option = document.createElement('option');
                option.value = escuela.id_escuela;
                option.textContent = escuela.nombre;
                escuelaSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar las escuelas:', error);
        });
});

        function cerrarModalEdicion() {
            const modal = document.getElementById('modalEdicion');
            modal.style.display = 'none';
            document.body.classList.remove('no-scroll'); // Restaurar el scroll
        }



        function mostrarModalConfirmacion(mensaje, accion, dni = null) {
            const modal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            confirmMessage.textContent = mensaje;
            currentAction = accion;
            currentDni = dni;
            modal.style.display = 'block';
        }

        function cerrarModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            currentAction = null;
            currentDni = null;
        }

        document.getElementById('confirmActionButton').addEventListener('click', () => {
            if (currentAction === 'agregar') {
                agregarPrivilegios(currentDni);
            } else if (currentAction === 'baja') {
                registrarBaja(currentDni);
            } else if (currentAction === 'remover') {
                removerPermisos(currentDni);
            }
            cerrarModal();
        });

        document.getElementById('closeConfirmModal').addEventListener('click', cerrarModal);
        document.getElementById('cancelConfirmButton').addEventListener('click', cerrarModal);

        function agregarPrivilegios(dni) {
            const token = localStorage.getItem('authToken');
        fetch(`http://localhost:3000/miembros/subirprivilegios/${dni}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json' // Opcional, según la configuración del backend
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al agregar privilegios.');
            }
            showAlert('success', 'Instructor asignado con éxito.');
            cargarMiembros(); // Recargar la grilla
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al asignar privilegios.');
        });
    }

        function removerPermisos(dni) {
            const token = localStorage.getItem('authToken');
            fetch(`http://localhost:3000/miembros/bajarPrivilegios/${dni}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json' // Opcional, según la configuración del backend
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al remover privilegios.');
                }
                showAlert('success', 'El miembro ahora tiene privilegios reducidos.');
                cargarMiembros(); // Recargar la grilla
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', `Error al remover privilegios: ${error.message}`);
            });
        }
        function registrarBaja(dni) {
            const token = localStorage.getItem('authToken');
            fetch(`http://localhost:3000/miembros/${dni}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json' // Opcional, según la configuración del backend
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { 
                            throw new Error(text); 
                        });
                    }
                    showAlert('success', 'Baja registrada con éxito.');
                    cargarMiembros(); // Recargar la grilla
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', `Error al registrar baja: ${error.message}`);
                });
        }

        function agregarMiembro(dni) {
            mostrarModalConfirmacion('¿Estás seguro de cambiar el Rol a Instructor?', 'agregar', dni);
        }
        function removerInstructor(dni) {
            mostrarModalConfirmacion('¿Estás seguro de cambiar el Rol a Alumno?', 'remover', dni);
        }

        function darDeBaja(dni) {
            mostrarModalConfirmacion('¿Estás seguro de dar de baja a este Usuario?', 'baja', dni);
        }

            

            // Nueva URL para la búsqueda de miembros con filtros
            const buscarUrl = 'http://localhost:3000/miembros/buscar';
            let miembros = [];
            let currentPage = 1;
            const registrosPorPagina = 15;

            // Función para calcular la edad
            function calcularEdad(fechaNacimiento) {
                const hoy = new Date();
                const nacimiento = new Date(fechaNacimiento);
                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                const mes = hoy.getMonth() - nacimiento.getMonth();
                if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                    edad--;
                }
                return edad;
            }

        function buscarMiembros(e) {
            e.preventDefault(); // Evita la recarga de la página

            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const dni_miembro = document.getElementById('dni').value;
            const id_cinto = document.getElementById('cinto').value;
            const id_escuela = document.getElementById('escuela').value;
            const estado = document.getElementById('estado').value; // Obtener el valor del estado

            const queryParams = new URLSearchParams({
                nombre,
                apellido,
                dni_miembro,
                id_cinto,
                id_escuela,
                estado // Añadir estado a los parámetros de búsqueda
            });

            const token = localStorage.getItem('authToken'); // Obtener el token desde localStorage

            if (token) {
                fetch(`${buscarUrl}?${queryParams.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // Agregar el token en el encabezado
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se encontraron miembros con los filtros proporcionados.');
                    }
                    return response.json();
                })
                .then(data => {
                    miembros = data;
                    if (miembros.length === 0) {
                        mostrarMensajeNoResultados();
                    } else {
                        mostrarPagina(currentPage);
                        actualizarPaginador();
                        mostrarTotalRegistros();
                    }
                })
                .catch(error => {
                    console.error('Error en la búsqueda de miembros:', error);
                    mostrarMensajeNoResultados();
                });
            } else {
                console.error('No se encontró el token de autenticación');
                // Aquí podrías redirigir al usuario a la página de login si no hay token
            }
        }

            // Función para mostrar mensaje cuando no se encuentran resultados
            function mostrarMensajeNoResultados() {
                const tableBody = document.querySelector('#miTabla tbody');
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron resultados.</td></tr>';
                document.getElementById('totalRegistros').textContent = 'Total de Registros: 0';
                document.getElementById('totalPaginas').textContent = 0; // Actualiza las páginas
            }

            // Función para limpiar los filtros
            function limpiarFiltros() {
                document.getElementById('nombre').value = '';
                document.getElementById('apellido').value = '';
                document.getElementById('dni').value = '';
                document.getElementById('cinto').value = '';
                document.getElementById('escuela').value = '';
                document.getElementById('estado').value = '';
                // También puedes agregar otros filtros aquí si es necesario
                // Cargar todos los miembros
                cargarMiembros();
            }

            function mostrarPagina(pagina) {
                const tableBody = document.querySelector('#miTabla tbody');
                tableBody.innerHTML = '';

                const start = (pagina - 1) * registrosPorPagina;
                const end = start + registrosPorPagina;
                const miembrosPagina = miembros.slice(start, end);

                miembrosPagina.forEach(miembro => {
                    const row = document.createElement('tr');
                    const rutaFichaMedica = miembro.ficha_medica ? `../../../Backend/${miembro.ficha_medica}` : '';

                    row.innerHTML = `
                        <td>${miembro.dni_miembro}</td>
                        <td>${miembro.nombre}</td>
                        <td>${miembro.apellido}</td>
                        <td>${miembro.telefono}</td>
                        <td>${calcularEdad(miembro.fecha_nacimiento)} años</td>
                        <td>${miembro.grupo_sanguineo}</td>
                        <td>${miembro.cinto || 'Sin cinto'}</td>
                        <td>${miembro.escuela || 'Sin escuela'}</td>
                        <td>${miembro.rol}</td>
                        <td>${miembro.activo ? 'Activo' : 'Inactivo'}</td>
                        <td>
                            <!-- Ícono de ficha médica -->
                            ${miembro.ficha_medica 
                                ? `<a href="${rutaFichaMedica}" target="_blank" download>
                                    <i class="fa-solid fa-cloud-arrow-down icon-download"></i></a>`
                                : `<i class="fa-solid fa-cloud-arrow-down icon-download-disabled" title="No hay ficha médica" onclick="showAlert('error','Este miembro no tiene ficha médica disponible');"></i>`}

                            <!-- Íconos de cambio de rol -->
                            ${miembro.rol === 'Administrador' 
                                ? `<i class="fa-solid fa-user-minus icon-disabled" title="No puedes cambiar el rol de un administrador"></i>`
                                : miembro.rol === 'Instructor' 
                                    ? `<i class="fa-solid fa-user-minus icon-remove" title="Hacer Miembro" onclick="removerInstructor(${miembro.dni_miembro})"></i>`
                                    : `<i class="fa-solid fa-user-plus icon-add" title="Hacer Instructor" onclick="agregarMiembro(${miembro.dni_miembro})"></i>`}

                            <!-- Ícono de dar de baja -->
                            ${miembro.rol === 'Administrador' 
                                ? `<i class="fa-solid fa-ban icon-disabled" title="No puedes dar de baja a un administrador"></i>`
                                : `<i class="fa-solid fa-ban icon-ban" title="Dar de baja" onclick="darDeBaja(${miembro.dni_miembro})"></i>`}

                            <!-- Ícono de editar -->
                            ${miembro.rol === 'Administrador'
                                ? `<i class="fa-solid fa-pen-to-square icon-disabled" title="No se puede modificar a un administrador"></i>`
                                : `<i class="fa-solid fa-pen-to-square icon-edit" title="Modificar miembro" onclick="abrirModalEdicion(${miembro.dni_miembro})"></i>`}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }




            // Función para mostrar el total de registros
            function mostrarTotalRegistros() {
                const totalRegistros = miembros.length;
                document.getElementById('totalRegistros').textContent = `Total de Registros: ${totalRegistros}`;
            }

            // Función para actualizar el paginador
            function actualizarPaginador() {
                const totalPaginas = Math.ceil(miembros.length / registrosPorPagina);
                document.getElementById('totalPaginas').textContent = totalPaginas;

                const pageSelect = document.getElementById('pageSelect');
                pageSelect.innerHTML = '';

                for (let i = 1; i <= totalPaginas; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    pageSelect.appendChild(option);
                }
            }
            // Cambiar de página
            document.getElementById('pageSelect').addEventListener('change', (event) => {
                currentPage = parseInt(event.target.value);
                mostrarPagina(currentPage);
            });
            // Asignar el evento de búsqueda al formulario
            document.querySelector('.search-filters form').addEventListener('submit', buscarMiembros);

            // Cargar los miembros al inicio
            cargarMiembros();

            // Función para cargar todos los miembros al inicio
            function cargarMiembros() {
    const token = localStorage.getItem('authToken'); // Obtener el token desde localStorage

    if (token) {
        fetch(buscarUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}` // Incluir el token en los encabezados
            }
        })
        .then(response => response.json())
        .then(data => {
            miembros = data;
            mostrarPagina(currentPage);
            actualizarPaginador();
            mostrarTotalRegistros();
        })
        .catch(error => {
            console.error('Error al cargar los miembros:', error);
        });
    } else {
        console.error('No se encontró el token de autenticación');
        // Aquí podrías redirigir al usuario a la página de login si no hay token
    }
}

    </script>

<script>
    // Función para exportar a Excel solo los resultados actuales de la grilla
    function exportToExcel() {
        const wb = XLSX.utils.book_new(); // Crear un nuevo libro de Excel
        const ws_data = [];

        // Definir los encabezados manualmente
        const headers = [
            'Nro Documento',
            'Nombre',
            'Apellido',
            'Teléfono',
            'Dirección',
            'Email',
            'Fecha de Nacimiento',      
            'Edad',
            'Fecha de Alta',
            'Grupo Sanguíneo',
            'Cinto',
            'Escuela',
            'Estado',
            'Rol'
        ];
        ws_data.push(headers); // Agregar encabezados a la hoja

        miembros.forEach(miembro => {
            const rowData = [
                miembro.dni_miembro,
                miembro.nombre,
                miembro.apellido,
                miembro.telefono,
                miembro.direccion,
                miembro.email,
                new Date(miembro.fecha_nacimiento).toLocaleDateString(), // Formato de fecha
                calcularEdad(miembro.fecha_nacimiento), // Calcula la edad
                miembro.fecha_alta ? new Date(miembro.fecha_alta).toLocaleDateString() : 'S/D', // Si es null, muestra 'No disponible'
                miembro.grupo_sanguineo,
                miembro.cinto || 'Sin cinto',
                miembro.escuela || 'Sin escuela',
                miembro.activo ? 'Activo' : 'Inactivo',
                miembro.rol
            ];
            ws_data.push(rowData); // Agregar cada fila con datos del miembro
        });



        const ws = XLSX.utils.aoa_to_sheet(ws_data); // Crear hoja con los datos
        XLSX.utils.book_append_sheet(wb, ws, 'Resultados'); // Agregar hoja al libro

        // Crear nombre de archivo con la fecha actual en formato dd-mm-aa
        const fechaActual = new Date();
        const dia = String(fechaActual.getDate()).padStart(2, '0');
        const mes = String(fechaActual.getMonth() + 1).padStart(2, '0'); // Meses van de 0 a 11
        const anio = String(fechaActual.getFullYear()).slice(-2); // Solo los últimos dos dígitos del año
        const nombreArchivo = `Reporte-miembros-${dia}-${mes}-${anio}.xlsx`;

        // Descargar el archivo Excel con el nuevo nombre
        XLSX.writeFile(wb, nombreArchivo);
    }

    // Función para verificar el token y el rol del usuario
    function verificarTokenYRol() {
            const token = localStorage.getItem('authToken'); // Asegúrate de usar el nombre correcto

            if (!token) {
                // Si no hay token, redirigir al home
                window.location.href = '../login.html'; // Cambia esto a la URL de tu página de inicio
                return;
            }

            // Decodificar el JWT
            const usuario = JSON.parse(atob(token.split('.')[1])); // Decodifica la parte payload del token

            // Verificar si el usuario tiene el rol de administrador
            if (usuario.rol !== 'Administrador') {
                // Si no es administrador, redirigir al home
                localStorage.removeItem('authToken'); // Asegúrate de usar el nombre correcto
                window.location.href = '../login.html'; // Cambia esto a la URL de tu página de inicio
            } else if (!usuario.estado) {
                // Si el usuario no está activo, redirigir a Mercado Pago
                localStorage.removeItem('authToken'); // Asegúrate de usar el nombre correcto
                window.location.href = '../cuotaimpaga.html'; // Redirige a la página de cobros
            }
        }

        // Llamar a la función al cargar la página
        document.addEventListener('DOMContentLoaded', verificarTokenYRol);
        // Función para cerrar sesión
        function cerrarSesion() {
                    localStorage.removeItem('authToken'); // Elimina el token del local storage
                    window.location.href = '../login.html'; // Cambia esto a la URL de tu página de inicio de sesión
                }
</script>


</body>
</html>


